<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sidebar App Moderno</title>
    <!-- Enlace a Font Awesome para los íconos -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos generales para el cuerpo de la página */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            background-color: #f0f2f5; /* Fondo claro para el cuerpo */
            overflow-x: hidden; /* Evita el scroll horizontal durante la transición */
        }
        
        /* Estilos para el contenedor principal del sidebar */
        .sidebar {
            width: 250px; /* Ancho inicial del sidebar */
            background-color: #2c3e50; /* Color oscuro para el fondo del sidebar */
            color: white; /* Color de texto blanco */
            padding: 20px 0; /* Espaciado interno superior e inferior */
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1); /* Sombra sutil a la derecha */
            display: flex;
            flex-direction: column; /* Organiza los elementos en columna */
            height: 100vh; /* Ocupa toda la altura de la ventana (viewport height) */
            position: fixed; /* Fija el sidebar en la pantalla */
            left: 0; /* Alineado a la izquierda */
            top: 0; /* Alineado en la parte superior */
            transition: width 0.3s ease; /* Transición suave para el ancho */
            z-index: 1000; /* Asegura que esté por encima de otros elementos */
        }

        /* Estilos para el estado colapsado del sidebar principal */
        .sidebar.collapsed {
            width: 80px; /* Ancho reducido cuando está colapsado */
        }

        /* Estilos para el encabezado del sidebar principal */
        .sidebar-header {
            display: flex;
            justify-content: space-between; /* Espacio entre el título y el botón */
            align-items: center;
            margin-bottom: 30px; /* Margen inferior */
            padding: 0 20px; /* Espaciado lateral */
            transition: padding 0.3s ease; /* Transición para el padding */
        }

        .sidebar.collapsed .sidebar-header {
            padding: 0 10px; /* Reduce el padding cuando colapsa */
            justify-content: center; /* Centra el botón cuando el título desaparece */
        }

        .sidebar-header h2 {
            margin: 0; /* Elimina el margen por defecto del h2 */
            font-size: 1.8em; /* Tamaño de fuente */
            color: #ecf0f1; /* Color del título */
            white-space: nowrap; /* Evita que el texto se rompa */
            overflow: hidden; /* Oculta el texto que se desborda */
            transition: opacity 0.3s ease, font-size 0.3s ease; /* Transición para la opacidad y tamaño */
        }

        .sidebar.collapsed .sidebar-header h2 {
            opacity: 0; /* Oculta el título cuando colapsa */
            font-size: 0; /* Reduce el tamaño para que no ocupe espacio */
            width: 0; /* Asegura que no ocupe espacio */
        }

        /* Estilos para el botón de alternar (toggle) del sidebar principal */
        .sidebar-toggle {
            background: none;
            border: none;
            color: #ecf0f1;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .sidebar-toggle:hover {
            background-color: #34495e;
            transform: scale(1.1); /* Efecto de escala al pasar el ratón */
        }

        /* Estilos para las secciones desplegables dentro del sidebar */
        .sidebar-section {
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); /* Separador entre secciones */
            padding-bottom: 10px;
        }

        .sidebar-section:last-of-type {
            border-bottom: none; /* Sin separador para la última sección */
            padding-bottom: 0;
        }

        /* Estilos para el encabezado de cada sección desplegable */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            cursor: pointer;
            background-color: #34495e; /* Fondo ligeramente diferente para el encabezado */
            border-radius: 5px;
            margin: 0 10px; /* Margen desde los bordes del sidebar */
            transition: background-color 0.3s ease;
        }

        .section-header:hover {
            background-color: #4a627a;
        }

        .section-header h3 {
            margin: 0;
            font-size: 1.1em;
            color: #ecf0f1;
            display: flex;
            align-items: center;
            white-space: nowrap; /* Evita que el texto se rompa */
            overflow: hidden; /* Oculta el texto que se desborda */
            transition: opacity 0.3s ease, width 0.3s ease;
        }

        .section-header h3 i {
            margin-right: 10px;
            font-size: 1.2em;
        }

        /* Oculta el texto del encabezado de la sección cuando el sidebar principal está colapsado */
        .sidebar.collapsed .section-header h3 {
            opacity: 0;
            width: 0;
        }
        .sidebar.collapsed .section-header h3 i {
            margin-right: 0; /* Centra el icono */
        }

        /* Estilos para el botón de alternar de la sección */
        .section-toggle {
            background: none;
            border: none;
            color: #ecf0f1;
            font-size: 20px; /* Tamaño fijo para el ícono */
            width: 30px; /* Ancho fijo para el botón */
            height: 30px; /* Alto fijo para el botón */
            display: flex; /* Usar flexbox para centrar el ícono */
            align-items: center; /* Centrar verticalmente */
            justify-content: center; /* Centrar horizontalmente */
            cursor: pointer;
            border-radius: 5px;
            transition: transform 0.3s ease;
        }

        /* Asegura que el ícono dentro del botón de alternar herede el tamaño fijo */
        .section-toggle i {
            font-size: inherit; /* Hereda el tamaño de 20px del padre (.section-toggle) */
            line-height: 1; /* Para asegurar la alineación vertical */
        }

        /* Rotación del icono de la flecha al expandir/colapsar */
        .section-content.expanded + .section-header .section-toggle i {
            transform: rotate(180deg);
        }

        /* Estilos para el contenido de cada sección (la lista de pestañas) */
        .section-content {
            list-style: none;
            padding: 0;
            margin: 5px 0 0 0; /* Ajusta el margen superior */
            overflow: hidden; /* Crucial para la animación de max-height */
            transition: max-height 0.3s ease-out; /* Animación suave */
            max-height: 0; /* Por defecto, colapsado */
        }

        .section-content.expanded {
            max-height: 500px; /* Un valor suficientemente grande para el contenido, se ajustará con JS */
        }

        /* Estilos para los enlaces de las pestañas dentro de las secciones */
        .sidebar ul li a {
            display: flex; /* Permite alinear ícono y texto */
            align-items: center; /* Centra verticalmente los elementos */
            padding: 15px 20px; /* Espaciado interno */
            color: #ecf0f1; /* Color de texto por defecto */
            text-decoration: none; /* Elimina el subrayado */
            font-size: 1.1em; /* Tamaño de fuente */
            transition: background-color 0.3s ease, color 0.3s ease, padding 0.3s ease; /* Transición suave */
        }

        /* Ajustes de padding y centrado cuando el sidebar principal está colapsado */
        .sidebar.collapsed ul li a {
            padding: 15px 0; /* Reduce el padding horizontal */
            justify-content: center; /* Centra los íconos */
        }

        /* Estilos para los íconos dentro de los enlaces de las pestañas */
        .sidebar ul li a i {
            margin-right: 15px; /* Margen a la derecha del ícono */
            font-size: 1.3em; /* Tamaño del ícono */
            transition: margin-right 0.3s ease; /* Transición para el margen */
        }

        .sidebar.collapsed ul li a i {
            margin-right: 0; /* Elimina el margen cuando el sidebar principal colapsa */
        }

        /* Estilos para el texto de las pestañas */
        .sidebar ul li a span {
            white-space: nowrap; /* Evita que el texto se rompa */
            overflow: hidden; /* Oculta el texto que se desborda */
            transition: opacity 0.3s ease, width 0.3s ease; /* Transición suave para la opacidad y ancho */
            width: auto; /* Ancho automático por defecto */
            opacity: 1; /* Visible por defecto */
        }

        .sidebar.collapsed ul li a span {
            opacity: 0; /* Oculta el texto cuando el sidebar principal colapsa */
            width: 0; /* Reduce el ancho para que no ocupe espacio */
        }

        /* Efecto al pasar el ratón (hover) sobre los enlaces de las pestañas */
        .sidebar ul li a:hover {
            background-color: #34495e; /* Un tono un poco más claro al pasar el ratón */
            color: #ffffff; /* Color de texto blanco */
        }

        /* Estilos para la pestaña activa */
        .sidebar ul li.active a {
            background-color: #3498db; /* Color de acento para la pestaña activa (azul) */
            color: #ffffff; /* Color de texto blanco */
            font-weight: bold; /* Texto en negrita */
            border-left: 5px solid #2980b9; /* Indicador visual de activo: una línea azul oscuro a la izquierda */
        }

        /* Ajuste del indicador activo cuando el sidebar principal está colapsado */
        .sidebar.collapsed ul li.active a {
            border-left: none; /* Elimina el borde izquierdo */
            border-bottom: 5px solid #2980b9; /* Añade un borde inferior como indicador */
        }

        /* Estilos para el contenedor principal de contenido */
        .main-content {
            margin-left: 250px; /* Deja espacio a la izquierda para el sidebar fijo */
            padding: 20px; /* Espaciado interno */
            flex-grow: 1; /* Permite que el contenido principal ocupe el espacio restante */
            background-color: #f9f9f9; /* Nuevo color de fondo: gris muy claro */
            min-height: 100vh; /* Asegura que ocupe al menos toda la altura de la ventana */
            box-shadow: inset 5px 0 10px -5px rgba(0, 0, 0, 0.05); /* Sombra sutil al borde del contenido */
            transition: margin-left 0.3s ease; /* Transición suave para el margen */
            display: flex; /* Usar flexbox para organizar header y content-area */
            flex-direction: column;
            font-family: 'Inter', sans-serif;
        }
        .main-content.shifted {
            margin-left: 80px; /* Ajusta el margen cuando el sidebar está colapsado */
        }

        /* Estilos para el área de contenido dinámico */
        .content-area {
            flex-grow: 1; /* Permite que el área de contenido ocupe el espacio restante */
            padding-top: 20px; /* Espacio entre el mensaje de bienvenida y el contenido de la pestaña */
        }

        /* Estilos para la sección de información del usuario (no interactiva) */
        .user-name-info {
            border-top: 1px solid rgba(255, 255, 255, 0.1); /* Separador */
            padding-top: 10px;
            margin-top: 10px; /* Separación de la sección de logout */
        }
        .user-info-display {
            display: flex;
            align-items: center;
            padding: 15px 20px; /* Similar a las pestañas */
            color: #ecf0f1; /* Color de texto por defecto */
            font-size: 1.1em; /* Tamaño de fuente */
            background-color: #2c3e50; /* Fondo del sidebar, no cambia */
            border-radius: 5px; /* Bordes redondeados */
            margin: 0 10px; /* Margen lateral */
        }
        .user-info-display i {
            margin-right: 15px; /* Margen a la derecha del ícono */
            font-size: 1.3em; /* Tamaño del ícono */
        }
        /* Ajustes para cuando el sidebar está colapsado */
        .sidebar.collapsed .user-info-display {
            padding: 15px 0; /* Reduce el padding horizontal */
            justify-content: center; /* Centra el ícono */
        }
        .sidebar.collapsed .user-info-display i {
            margin-right: 0; /* Elimina el margen */
        }
        .sidebar.collapsed .user-info-display .user-name {
            display: none; /* Oculta el nombre de usuario */
        }
        
        /* Estilos para los mensajes de bienvenida y logout */
        .main-content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
        }

        /* Estilos específicos para el formulario de registro de vehículos */
        .btn-animation { transition: all 0.2s ease-in-out; }
        .btn-animation:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
        .input-focus-animation:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25); }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); z-index: 999; }
        .modal-content { z-index: 1000; transform: translateY(-20px); opacity: 0; transition: opacity 0.3s ease-out, transform 0.3s ease-out; }
        .modal-content.show { opacity: 1; transform: translateY(0); }
        .message-success { background-color: #d1fae5; border-color: #a7f3d0; color: #065f46; }
        .message-error { background-color: #fee2e2; border-color: #fca5a5; color: #991b1b; }
        .message-info { background-color: #e0f2fe; border-color: #93c5fd; color: #1e40af; }
    </style>
</head>
<body>

    <!-- Contenedor del Sidebar -->
    <div class="sidebar" id="sidebar">
        <!-- Encabezado del Sidebar -->
        <div class="sidebar-header">
            <h2>Gestión App</h2>
            <button class="sidebar-toggle" id="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <!-- Sección de Navegación -->
        <div class="sidebar-section">
            <div class="section-header" data-section="navegacion">
                <h3><i class="fas fa-th-large"></i><span>Navegación</span></h3>
                <button class="section-toggle"><i class="fas fa-chevron-down"></i></button>
            </div>
            <ul class="section-content expanded" id="navegacion-content">
                <li><a href="#" data-tab="inicio"><i class="fas fa-home"></i><span>Inicio</span></a></li>
                <li><a href="#" data-tab="vehiculos"><i class="fas fa-car"></i><span>Vehículos</span></a></li>
                <li><a href="#" data-tab="ordenes"><i class="fas fa-clipboard-list"></i><span>Órdenes</span></a></li>
            </ul>
        </div>
        
        <!-- Sección de Información del Usuario -->
        <div class="sidebar-section info-section" id="info-section">
            <div class="section-header" data-section="informacion">
                <h3><i class="fas fa-user-circle"></i><span>Información</span></h3>
                <button class="section-toggle"><i class="fas fa-chevron-down"></i></button>
            </div>
            <ul class="section-content expanded" id="informacion-content">
                <li><a href="#" data-tab="perfil"><i class="fas fa-id-card"></i><span>Mi Perfil</span></a></li>
                <li><a href="#" data-tab="ajustes"><i class="fas fa-cog"></i><span>Ajustes</span></a></li>
            </ul>
            <div class="user-name-info" id="user-info">
                <div class="user-info-display">
                    <i class="fas fa-user"></i>
                    <span class="user-name" id="sidebar-user-name"></span>
                </div>
            </div>
        </div>

        <!-- Sección para Cerrar Sesión -->
        <div class="sidebar-section" id="logout-section">
            <div class="section-header" data-section="logout" id="logout-section-header">
                <h3><i class="fas fa-sign-out-alt"></i><span>Cerrar Sesión</span></h3>
            </div>
        </div>
    </div>

    <!-- Contenedor del Contenido Principal -->
    <div class="main-content" id="main-content">
        <!-- Encabezado del contenido principal -->
        <header class="main-content-header">
            <h1 id="welcome-message" class="text-3xl sm:text-4xl font-bold text-gray-800"></h1>
        </header>
        <!-- Área para renderizar el contenido de las pestañas -->
        <div class="content-area" id="content-area">
            <!-- El contenido dinámico de las pestañas se insertará aquí -->
        </div>
    </div>

    <!-- Modal de Registro Exitoso -->
    <div id="registration-modal" class="fixed inset-0 flex items-center justify-center hidden modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full modal-content">
            <h3 class="text-2xl font-bold text-green-700 text-center mb-4" id="modal-title"></h3>
            <p class="text-gray-700 text-center mb-4" id="modal-message"></p>
            <div id="modal-content-details" class="text-left bg-green-50 text-green-800 p-4 rounded-lg space-y-2 mb-6">
                <!-- Los detalles del registro se insertarán aquí por JavaScript -->
            </div>
            <div class="flex justify-center space-x-4">
                <button type="button" onclick="handleAcceptRegistration()" class="btn-animation w-full flex items-center justify-center py-3 px-4 border border-transparent rounded-xl shadow-lg text-base font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Aceptar
                </button>
            </div>
        </div>
    </div>


    <script>
        // --- Declaración de Variables Globales y Selectores del DOM ---
        let loggedInUser = null;
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const mainContent = document.getElementById('main-content');
        const contentArea = document.getElementById('content-area');
        const sidebarSections = document.querySelectorAll('.sidebar-section');
        const welcomeMessage = document.getElementById('welcome-message');
        const infoSection = document.getElementById('info-section');
        const logoutSectionHeader = document.getElementById('logout-section-header');
        const sidebarUserName = document.getElementById('sidebar-user-name');

        // --- Lógica del Toggle del Sidebar Principal ---
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('shifted');
            // Cierra todas las secciones expandidas al colapsar el sidebar
            if (sidebar.classList.contains('collapsed')) {
                sidebarSections.forEach(section => {
                    const content = section.querySelector('.section-content');
                    if (content && content.classList.contains('expanded')) {
                        content.classList.remove('expanded');
                        content.style.maxHeight = '0';
                    }
                });
            }
        });

        // --- Lógica de los Toggles de las Secciones del Sidebar ---
        sidebarSections.forEach(section => {
            const header = section.querySelector('.section-header');
            if (header) {
                header.addEventListener('click', (e) => {
                    // Previene la acción si el sidebar principal está colapsado y no es el ícono de toggle
                    if (sidebar.classList.contains('collapsed') && !e.target.closest('.section-toggle')) {
                        return;
                    }
                    const content = section.querySelector('.section-content');
                    if (content) {
                        const isExpanded = content.classList.toggle('expanded');
                        content.style.maxHeight = isExpanded ? `${content.scrollHeight}px` : '0';
                    }
                });
            }
        });

        // --- Lógica de Renderizado de Contenido y Navegación entre Pestañas ---
        const renderContent = (tabId) => {
            let pageTitle = '';
            // Limpia el contenedor de mensajes
            const welcomeMessage = document.getElementById('welcome-message');
            welcomeMessage.classList.add('hidden'); // Ocultar el mensaje por defecto
            contentArea.innerHTML = ''; // Limpiar el contenido anterior

            if (tabId === 'inicio') {
                pageTitle = `Hola, ${loggedInUser ? loggedInUser.Cliente_Nombre : 'Usuario'}.`;
                welcomeMessage.textContent = pageTitle;
                welcomeMessage.classList.remove('hidden'); // Mostrar el mensaje de bienvenida
            } else if (tabId === 'vehiculos') {
                pageTitle = 'Registrar Vehículo';
                welcomeMessage.textContent = pageTitle;
                welcomeMessage.classList.remove('hidden');
                loadVehiculosContent(); // Llama a la nueva función para cargar el contenido
            } else if (tabId === 'ordenes') {
                pageTitle = 'Órdenes';
                welcomeMessage.textContent = pageTitle;
                welcomeMessage.classList.remove('hidden');
                loadCatalogContent(); // Llama a la nueva función para cargar el contenido de órdenes
            } else if (tabId === 'perfil') {
                pageTitle = 'Mi Perfil';
                contentArea.innerHTML = `<h2 class="text-xl font-bold mb-4">${pageTitle}</h2><p>Contenido de la sección Mi Perfil.</p>`;
            } else if (tabId === 'ajustes') {
                pageTitle = 'Ajustes';
                contentArea.innerHTML = `<h2 class="text-xl font-bold mb-4">${pageTitle}</h2><p>Contenido de la sección de Ajustes.</p>`;
            }
        };
        
        // --- Nueva función para cargar el contenido de RegVehiculos.html dinámicamente ---
        const loadVehiculosContent = async () => {
            try {
                // Muestra un mensaje de carga mientras se obtiene el contenido
                contentArea.innerHTML = '<div class="flex justify-center items-center h-64"><div class="animate-spin rounded-full h-32 w-32 border-b-2 border-gray-900"></div></div>';
                
                const response = await fetch('RegVehiculos.html');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const htmlText = await response.text();

                // Crea un elemento temporal para parsear el HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlText, 'text/html');
                
                // Encuentra y extrae el contenido del formulario
                const vehicleFormContainer = doc.querySelector('.w-full.max-w-2xl.mx-auto');
                
                if (vehicleFormContainer) {
                    // Inserta solo el contenido del formulario en el área de contenido principal
                    contentArea.innerHTML = vehicleFormContainer.outerHTML;
                    // Llama a la función de configuración después de que el HTML esté en el DOM
                    setupVehicleRegistrationForm(); 
                } else {
                    contentArea.innerHTML = '<p class="text-center text-red-500">No se pudo encontrar el formulario de registro de vehículos.</p>';
                }
                
            } catch (error) {
                console.error('Error al cargar el contenido de RegVehiculos.html:', error);
                contentArea.innerHTML = '<p class="text-center text-red-500">Hubo un error al cargar el contenido. Por favor, inténtelo de nuevo.</p>';
            }
        };

        // --- Nueva función para cargar el contenido de catalog.html dinámicamente ---
        const loadCatalogContent = async () => {
            try {
                contentArea.innerHTML = '<div class="flex justify-center items-center h-64"><div class="animate-spin rounded-full h-32 w-32 border-b-2 border-gray-900"></div></div>';
                
                const response = await fetch('catalogYogurt.html');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const htmlText = await response.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlText, 'text/html');
                
                const catalogContainer = doc.querySelector('.w-full.max-w-2xl.mx-auto');
                
                if (catalogContainer) {
                    contentArea.innerHTML = catalogContainer.outerHTML;
                    setupCatalogForm(); 
                } else {
                    contentArea.innerHTML = '<p class="text-center text-red-500">No se pudo encontrar el contenido del catálogo.</p>';
                }
                
            } catch (error) {
                console.error('Error al cargar el contenido de catalog.html:', error);
                contentArea.innerHTML = '<p class="text-center text-red-500">Hubo un error al cargar el contenido. Por favor, inténtelo de nuevo.</p>';
            }
        };

        // --- Lógica de la barra de navegación lateral ---
        document.querySelectorAll('.sidebar ul li a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const tabId = e.currentTarget.getAttribute('data-tab');
                
                // Actualiza la clase activa en el sidebar
                document.querySelectorAll('.sidebar ul li.active').forEach(item => {
                    item.classList.remove('active');
                });
                e.currentTarget.parentElement.classList.add('active');

                renderContent(tabId);
            });
        });

        // --- Funciones de bienvenida y nombre de usuario ---
        const displayWelcomeMessage = () => {
            const today = new Date();
            const hour = today.getHours();
            let greeting = '';
            if (hour >= 6 && hour < 12) {
                greeting = 'Buenos días';
            } else if (hour >= 12 && hour < 19) {
                greeting = 'Buenas tardes';
            } else {
                greeting = 'Buenas noches';
            }
            if (loggedInUser) {
                welcomeMessage.textContent = `${greeting}, ${loggedInUser.Cliente_Nombre}.`;
            } else {
                welcomeMessage.textContent = `${greeting}.`;
            }
        };

        const displayUserNameInSidebar = () => {
            if (loggedInUser) {
                sidebarUserName.textContent = loggedInUser.Cliente_Nombre;
            }
        };

        const setSectionMaxHeight = () => {
            const expandedSections = document.querySelectorAll('.section-content.expanded');
            expandedSections.forEach(section => {
                section.style.maxHeight = '0'; // reset before setting
                section.style.maxHeight = `${section.scrollHeight}px`;
            });
        };

        // --- Funcionalidad del formulario de registro de vehículos (ahora se llama después de cargar el contenido) ---
        const setupVehicleRegistrationForm = () => {
            const form = document.getElementById('vehicleRegistrationForm');
            if (!form) return;
            
            const registrationModal = document.getElementById('registration-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalDetails = document.getElementById('modal-content-details');

            form.addEventListener('submit', function(event) {
                event.preventDefault(); // Evita el envío del formulario tradicional

                const marca = document.getElementById('vehiculo-marca').value.trim();
                const modelo = document.getElementById('vehiculo-modelo').value.trim();
                const anio = document.getElementById('vehiculo-anio').value.trim();
                const placa = document.getElementById('vehiculo-placa').value.trim();
                
                if (!marca || !modelo || !anio || !placa) {
                    // Nota: el código original usaba un result-container, pero ahora usaremos el modal para la confirmación.
                    // Podrías agregar un mensaje de error aquí si lo deseas.
                    alert('Por favor, complete todos los campos.');
                    return;
                }
                
                // Simular registro exitoso
                const newVehicle = {
                    marca,
                    modelo,
                    anio,
                    placa
                };
                
                // Mostrar el modal con los datos del nuevo vehículo
                modalTitle.textContent = '¡Registro Exitoso!';
                modalMessage.textContent = 'El vehículo ha sido registrado con los siguientes datos:';
                modalDetails.innerHTML = `
                    <p><strong>Marca:</strong> ${newVehicle.marca}</p>
                    <p><strong>Modelo:</strong> ${newVehicle.modelo}</p>
                    <p><strong>Año:</strong> ${newVehicle.anio}</p>
                    <p><strong>Placa:</strong> ${newVehicle.placa}</p>
                `;

                registrationModal.classList.remove('hidden');
                setTimeout(() => {
                    registrationModal.querySelector('.modal-content').classList.add('show');
                }, 50);

                // Limpiar el formulario
                form.reset();
            });

            // Función para cerrar el modal
            window.handleAcceptRegistration = function() {
                registrationModal.querySelector('.modal-content').classList.remove('show');
                setTimeout(() => {
                    registrationModal.classList.add('hidden');
                }, 300);
            };
        };

        // --- Funcionalidad del formulario de catálogo (ahora se llama después de cargar el contenido) ---
        const setupCatalogForm = () => {
            // Aquí irá toda la lógica del archivo catalog.html
            // Inicializar las variables y agregar los event listeners
            
            const productSelectionForm = document.getElementById('productSelectionForm');
            if (!productSelectionForm) return;

            const productTypeSelect = document.getElementById('product-type-select');
            const hasSugarCheckbox = document.getElementById('has-sugar-checkbox');
            const flavorSelect = document.getElementById('flavor-select');
            const flavorInfo = document.getElementById('flavor-info');
            const quantityInput = document.getElementById('quantity-input');
            const addToCartButton = document.getElementById('add-to-cart-button');
            const cartMessageContainer = document.getElementById('cart-message-container');
            const cartTableBody = document.getElementById('cart-table-body');
            const cartTotalCostElement = document.getElementById('cart-total-cost');
            const cartTotalQuantityElement = document.getElementById('cart-total-quantity');
            const registrationModal = document.getElementById('registration-modal');
            const modalTitleElement = document.getElementById('modal-title');
            const modalMessageElement = document.getElementById('modal-message');
            const modalContentDetails = document.getElementById('modal-content-details');

            let cartItems = [];

            // --- DATOS MOCK DEL CATÁLOGO DE PRODUCTOS (se define aquí para esta vista) ---
            const baseProductTypes = [
                { name: 'Yogurt Batido', sizes: ['7 Oz', '23 Oz', '20 L'], baseCost: { '7 Oz': 1, '23 Oz': 3.5, '20 L': 70 }, moneda: 'USD', tienda: 'Tienda A' },
                { name: 'Yogurt Griego Natural', sizes: ['7 Oz', '23 Oz', '20 Kg'], baseCost: { '7 Oz': 1.25, '23 Oz': 4, '20 Kg': 100 }, moneda: 'USD', tienda: 'Tienda A' },
                { name: 'Yogurt Griego con Frutas', sizes: ['7 Oz', '23 Oz'], baseCost: { '7 Oz': 1.5, '23 Oz': 4.5 }, moneda: 'USD', tienda: 'Tienda A' },
                { name: 'Yogurt Líquido', sizes: ['900 ml'], baseCost: { '900 ml': 4.5 }, moneda: 'USD', tienda: 'Tienda A' },
            ];

            const allFlavors = [
                'Fresa', 'Mora', 'Piña', 'Parchita', 'Ciruela', 'Guanábana', 'Durazno', 'Dulce', 'Natural', 'Otro'
            ];

            const generateProductCatalog = () => {
                let id = 101;
                const catalog = [];
                baseProductTypes.forEach(productType => {
                    productType.sizes.forEach(size => {
                        let applicableFlavors = allFlavors;
                        if (productType.name === 'Yogurt Griego Natural') {
                            applicableFlavors = ['Natural'];
                        }
                        const sugarOptions = [true, false];
                        sugarOptions.forEach(hasSugar => {
                            applicableFlavors.forEach(flavor => {
                                const description = `${productType.name} ${size}`;
                                const presentation = `${hasSugar ? 'C/Azúcar' : 'S/Azúcar'}, Sabor: ${flavor}`;
                                const cost = productType.baseCost[size];
                                catalog.push({
                                    Plan_Cat_ID: id++,
                                    Plan_Cat_Descripción: description,
                                    Plan_Cat_Presentación: presentation,
                                    Plan_Cat_Costo: cost,
                                    Plan_Cat_Moneda: productType.moneda,
                                    Plan_Cat_Tienda: "Y42X"
                                });
                            });
                        });
                    });
                });
                return catalog;
            };

            const mockPlanesCat = generateProductCatalog();

            // Lógica para poblar el dropdown de Tipo de Producto
            const populateProductTypes = () => {
                const uniqueBaseDescriptions = [...new Set(mockPlanesCat.map(p => p.Plan_Cat_Descripción))];
                productTypeSelect.innerHTML = '<option value="">Selecciona producto</option>';
                uniqueBaseDescriptions.forEach(desc => {
                    const option = document.createElement('option');
                    option.value = desc;
                    option.textContent = desc;
                    productTypeSelect.appendChild(option);
                });
            };

            // Lógica para poblar el dropdown de Sabor basado en el producto seleccionado
            const populateFlavors = () => {
                const selectedProductType = productTypeSelect.value;
                const isYogurtGriegoNatural = selectedProductType === 'Yogurt Griego Natural 7 Oz' || selectedProductType === 'Yogurt Griego Natural 23 Oz' || selectedProductType === 'Yogurt Griego Natural 20 Kg';
                
                flavorSelect.innerHTML = '<option value="">Selecciona sabor</option>';
                flavorSelect.disabled = isYogurtGriegoNatural;
                
                if (isYogurtGriegoNatural) {
                    flavorInfo.classList.remove('hidden');
                } else {
                    flavorInfo.classList.add('hidden');
                    allFlavors.forEach(flavor => {
                        const option = document.createElement('option');
                        option.value = flavor;
                        option.textContent = flavor;
                        flavorSelect.appendChild(option);
                    });
                }
            };
            
            // Lógica para renderizar la tabla del carrito
            const renderCartTable = () => {
                cartTableBody.innerHTML = '';
                let totalCost = 0;
                let totalQuantity = 0;
                
                cartItems.forEach((item, index) => {
                    totalCost += item.cost * item.quantity;
                    totalQuantity += item.quantity;
                    
                    const row = document.createElement('tr');
                    row.classList.add('border-b', 'border-gray-100', 'hover:bg-gray-50', 'transition-colors');
                    row.innerHTML = `
                        <td class="py-2 px-3 text-left text-sm text-gray-700">${index + 1}</td>
                        <td class="py-2 px-3 text-center text-sm text-gray-700">${item.description} (${item.presentation})</td>
                        <td class="py-2 px-3 text-right text-sm text-gray-700">${item.quantity}</td>
                        <td class="py-2 px-3 text-right text-sm text-gray-700">${(item.cost * item.quantity).toFixed(2)}</td>
                        <td class="py-2 px-3 text-center">
                            <button type="button" class="text-red-500 hover:text-red-700" onclick="removeItemFromCart(${index})">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    `;
                    cartTableBody.appendChild(row);
                });
                
                cartTotalCostElement.textContent = totalCost.toFixed(2);
                cartTotalQuantityElement.textContent = totalQuantity;
            };

            // Función para añadir productos al carrito
            const addItemToCart = () => {
                const productType = productTypeSelect.value;
                const quantity = parseInt(quantityInput.value, 10);
                
                if (!productType || quantity <= 0) {
                    showMessage('Por favor, selecciona un producto y una cantidad válida.', 'error');
                    return;
                }
                
                const hasSugar = hasSugarCheckbox.checked;
                const flavor = flavorSelect.value || 'Natural';
                
                const selectedProduct = mockPlanesCat.find(p => 
                    p.Plan_Cat_Descripción === productType &&
                    p.Plan_Cat_Presentación.includes(hasSugar ? 'C/Azúcar' : 'S/Azúcar') &&
                    p.Plan_Cat_Presentación.includes(`Sabor: ${flavor}`)
                );
                
                if (!selectedProduct) {
                    showMessage('Producto no encontrado en el catálogo. Por favor, revisa tus selecciones.', 'error');
                    return;
                }
                
                const existingItemIndex = cartItems.findIndex(item => 
                    item.description === productType &&
                    item.presentation === selectedProduct.Plan_Cat_Presentación
                );
                
                if (existingItemIndex > -1) {
                    cartItems[existingItemIndex].quantity += quantity;
                } else {
                    cartItems.push({
                        id: selectedProduct.Plan_Cat_ID,
                        description: selectedProduct.Plan_Cat_Descripción,
                        presentation: selectedProduct.Plan_Cat_Presentación,
                        cost: selectedProduct.Plan_Cat_Costo,
                        quantity: quantity
                    });
                }
                
                renderCartTable();
                showMessage('Producto añadido al carrito.', 'success');
                productSelectionForm.reset();
                populateProductTypes();
                populateFlavors();
            };

            // Función para mostrar mensajes de estado
            const showMessage = (message, type) => {
                cartMessageContainer.textContent = message;
                cartMessageContainer.className = `mt-4 text-center p-3 rounded-lg border ${type === 'success' ? 'message-success' : 'message-error'}`;
                cartMessageContainer.classList.remove('hidden');
            };

            // Lógica para manejar el envío del formulario
            const handleFormSubmission = (event) => {
                event.preventDefault();
                
                if (cartItems.length === 0) {
                    showMessage('El carrito está vacío. Por favor, añade productos.', 'error');
                    return;
                }
                
                const orderData = {
                    Orden_ID: generateShortUUID(),
                    Orden_FechaHora: formatDateTime(new Date()),
                    Cliente_ID: loggedInUser.Cliente_ID,
                    Cliente_Nombre: loggedInUser.Cliente_Nombre,
                    Productos: cartItems.map(item => ({
                        id: item.id,
                        descripcion: `${item.description} (${item.presentation})`,
                        cantidad: item.quantity,
                        costo_unitario: item.cost,
                        costo_total: item.cost * item.quantity
                    })),
                    Total_Orden: cartItems.reduce((acc, item) => acc + (item.cost * item.quantity), 0).toFixed(2),
                    Estado: 'Pendiente'
                };
                
                // Mostrar el modal con los detalles de la orden
                modalTitleElement.textContent = '¡Orden Registrada!';
                modalMessageElement.textContent = 'Tu orden ha sido registrada con los siguientes detalles:';
                
                let productDetailsHtml = `
                    <p><strong>ID de Orden:</strong> ${orderData.Orden_ID}</p>
                    <p><strong>Cliente:</strong> ${orderData.Cliente_Nombre}</p>
                    <p><strong>Fecha:</strong> ${orderData.Orden_FechaHora}</p>
                    <h4 class="font-bold mt-4">Productos:</h4>
                    <ul>
                `;
                orderData.Productos.forEach(p => {
                    productDetailsHtml += `<li>- ${p.descripcion} (Cantidad: ${p.cantidad})</li>`;
                });
                productDetailsHtml += `
                    </ul>
                    <p class="font-bold mt-4">Total: $${orderData.Total_Orden}</p>
                `;
                modalContentDetails.innerHTML = productDetailsHtml;
                
                registrationModal.classList.remove('hidden');
                setTimeout(() => {
                    registrationModal.querySelector('.modal-content').classList.add('show');
                }, 50);

                // Limpiar el carrito y el formulario
                cartItems = [];
                renderCartTable();
                productSelectionForm.reset();
                populateProductTypes();
                populateFlavors();
                cartMessageContainer.classList.add('hidden');
            };

            // Función para generar un UUID corto de 5 caracteres alfanuméricos para Orden_ID
            function generateShortUUID() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ23456789';
                let result = '';
                for (let i = 0; i < 5; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }

            // Función para formatear la fecha y hora a dd/mm/aaaa hh:mm:ss
            function formatDateTime(date) {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0'); // Meses son 0-indexados
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
            }

            // Event Listeners
            productTypeSelect.addEventListener('change', populateFlavors);
            addToCartButton.addEventListener('click', addItemToCart);
            productSelectionForm.addEventListener('submit', handleFormSubmission);
            
            // Funciones iniciales
            populateProductTypes();
            populateFlavors();
            renderCartTable();

        };


        // --- Inicialización al cargar la página ---
        document.addEventListener('DOMContentLoaded', () => {
            let initialTabToLoad = 'inicio';
            // Verificar si el usuario está logueado para mostrar/ocultar la sección de información
            const userString = sessionStorage.getItem('loggedInUser');
            if (userString) {
                try {
                    loggedInUser = JSON.parse(userString);
                    if (loggedInUser && loggedInUser.Cliente_Nombre) {
                        infoSection.style.display = 'block';
                        console.log('Usuario logueado:', loggedInUser.Cliente_Nombre);
                    } else {
                        throw new Error('Formato de usuario no válido');
                    }
                } catch (e) {
                    console.error('Error al parsear loggedInUser de sessionStorage:', e);
                    infoSection.style.display = 'none';
                    initialTabToLoad = 'inicio';
                }
            } else {
                infoSection.style.display = 'none';
                console.log('No hay usuario logueado en sessionStorage. Sección "Información" oculta y se carga Inicio.');
                initialTabToLoad = 'inicio';
            }

            // Remueve la clase 'active' de todas las pestañas
            document.querySelectorAll('.sidebar ul li.active').forEach(item => {
                item.classList.remove('active');
            });

            // Encuentra y activa la pestaña inicial
            const targetLink = document.querySelector(`.sidebar ul li a[data-tab="${initialTabToLoad}"]`);
            if (targetLink) {
                targetLink.parentElement.classList.add('active');
            }

            renderContent(initialTabToLoad);
            setSectionMaxHeight(); 

            // Llama a displayWelcomeMessage() y displayUserNameInSidebar() una vez al cargar la página
            displayWelcomeMessage(); 
            displayUserNameInSidebar();
        });

        // Ajustar el max-height de las secciones expandidas al redimensionar la ventana
        window.addEventListener('resize', setSectionMaxHeight);

        // Lógica para el botón de cerrar sesión
        logoutSectionHeader.addEventListener('click', () => {
            sessionStorage.clear(); 
            window.location.href = './index.html'; 
        });
    </script>
</body>
</html>
